// ==============================================================================
// EMAIL DISPATCHER - Webhook Handler (Environment Variable Version)
// ==============================================================================
// Copy this ENTIRE file and paste it into Supabase Dashboard:
// Edge Functions ‚Üí dynamic-endpoint ‚Üí Code tab ‚Üí Replace all code

import { serve } from 'https://deno.land/std@0.168.0/http/server.ts';
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

const corsHeaders = {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
};

serve(async (req) => {
    // Handle CORS preflight
    if (req.method === 'OPTIONS') {
        return new Response('ok', { headers: corsHeaders });
    }

    try {
        console.log('üìß Email Dispatcher triggered');

        // Parse webhook payload
        const payload = await req.json();
        console.log('Webhook payload type:', payload.type);

        // Extract the email log record from webhook
        // Supabase webhooks send: { type: 'INSERT', table: 'email_logs', record: {...} }
        const emailLog = payload.record || payload;
        
        if (!emailLog || !emailLog.id) {
            throw new Error('Invalid webhook payload - missing email_logs record');
        }

        console.log(`Processing email log ID: ${emailLog.id}`);

        // Initialize Supabase Admin Client
        const supabaseAdmin = createClient(
            Deno.env.get('SUPABASE_URL') ?? '',
            Deno.env.get('SUPABASE_SERVICE_ROLE_KEY') ?? ''
        );

        // 1. Fetch the full email log with template
        const { data: fullLog, error: logError } = await supabaseAdmin
            .from('email_logs')
            .select(`
                *,
                email_templates (
                    event_trigger,
                    subject,
                    body_html
                )
            `)
            .eq('id', emailLog.id)
            .single();

        if (logError || !fullLog) {
            throw new Error(`Failed to fetch email log: ${logError?.message}`);
        }

        // Skip if already sent or failed
        if (fullLog.status !== 'PENDING') {
            console.log(`Email ${fullLog.id} already processed (status: ${fullLog.status})`);
            return new Response(JSON.stringify({ skipped: true, reason: 'Already processed' }), {
                headers: { ...corsHeaders, 'Content-Type': 'application/json' }
            });
        }

        // 2. Get credentials from environment variables (SECURE!)
        const RESEND_API_KEY = Deno.env.get('RESEND_API_KEY');
        const RESEND_DOMAIN = Deno.env.get('RESEND_DOMAIN');

        if (!RESEND_API_KEY) {
            console.error('‚ùå RESEND_API_KEY not set in environment variables');
            
            await supabaseAdmin
                .from('email_logs')
                .update({ 
                    status: 'FAILED', 
                    error_message: 'RESEND_API_KEY not configured in Edge Function secrets' 
                })
                .eq('id', fullLog.id);

            throw new Error('RESEND_API_KEY not configured. Set it with: supabase secrets set RESEND_API_KEY=your_key');
        }

        console.log(`‚úÖ Using Resend API (domain: ${RESEND_DOMAIN || 'default'})`);

        // 3. Render template with context data
        const template = fullLog.email_templates;
        const context = fullLog.context_data || {};

        let subject = template.subject;
        let body = template.body_html;

        // Simple template replacement
        Object.keys(context).forEach(key => {
            const regex = new RegExp(`{{${key}}}`, 'g');
            subject = subject.replace(regex, String(context[key] || ''));
            body = body.replace(regex, String(context[key] || ''));
        });

        // 4. Send email via Resend
        const fromEmail = RESEND_DOMAIN ? `noreply@${RESEND_DOMAIN}` : 'onboarding@resend.dev';
        console.log(`üì§ Sending email from: ${fromEmail} to: ${fullLog.recipient_email}`);

        const res = await fetch('https://api.resend.com/emails', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${RESEND_API_KEY}`
            },
            body: JSON.stringify({
                from: fromEmail,
                to: fullLog.recipient_email,
                subject: subject,
                html: body
            })
        });

        const data = await res.json();
        
        if (!res.ok) {
            console.error('‚ùå Resend API error:', data);
            
            // Update log as failed
            await supabaseAdmin
                .from('email_logs')
                .update({ 
                    status: 'FAILED', 
                    error_message: `Resend API error: ${JSON.stringify(data)}` 
                })
                .eq('id', fullLog.id);
            
            throw new Error(`Resend API error: ${JSON.stringify(data)}`);
        }

        console.log('‚úÖ Email sent via Resend! ID:', data.id);

        // 5. Update email log as SENT
        await supabaseAdmin
            .from('email_logs')
            .update({ 
                status: 'SENT', 
                sent_at: new Date().toISOString(),
                error_message: null
            })
            .eq('id', fullLog.id);

        return new Response(JSON.stringify({ 
            success: true, 
            email_id: fullLog.id,
            resend_id: data.id 
        }), {
            headers: { ...corsHeaders, 'Content-Type': 'application/json' }
        });

    } catch (err: any) {
        console.error('‚ùå Email Dispatch Error:', err);
        
        // Try to update the log as failed (if we have the ID)
        try {
            const payload = await req.clone().json();
            const emailLog = payload.record || payload;
            
            if (emailLog?.id) {
                const supabaseAdmin = createClient(
                    Deno.env.get('SUPABASE_URL') ?? '',
                    Deno.env.get('SUPABASE_SERVICE_ROLE_KEY') ?? ''
                );
                
                await supabaseAdmin
                    .from('email_logs')
                    .update({ 
                        status: 'FAILED', 
                        error_message: err.message 
                    })
                    .eq('id', emailLog.id);
            }
        } catch (updateErr) {
            console.error('Failed to update error status:', updateErr);
        }

        return new Response(JSON.stringify({ 
            error: err.message,
            details: err.stack 
        }), {
            status: 500,
            headers: { ...corsHeaders, 'Content-Type': 'application/json' }
        });
    }
});
